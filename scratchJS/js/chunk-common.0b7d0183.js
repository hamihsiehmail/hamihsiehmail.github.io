"use strict";(globalThis["webpackChunkcircleworld"]=globalThis["webpackChunkcircleworld"]||[]).push([[64],{11445:(e,t,o)=>{o.d(t,{o:()=>a});var s=o(3746);const a=(0,s.Q_)("asPostmanData",{state:()=>({thisOBJ:{}}),getters:{},actions:{addThis(e){console.log("theThis.$options.name:",e.$options.name),this.thisOBJ[e.$options.name]={theThis:e},console.log(" this.thisOBJ:",Object.keys(this.thisOBJ))},removeThis(e){delete this.thisOBJ[e.$options.name]}}})},57400:(e,t,o)=>{o.d(t,{B:()=>v});o(69665),o(18964);var s=o(3746),a=o(87790),n=o.n(a),i=o(36433),r=null;let c=!1,l=0,h={eLinePerTime:15+l,motion:{up:1,down:1,throw:1},exit:!1};async function d(e){return new Promise((t=>setTimeout(t,e)))}async function k(){if(h.eLinePerTime>0)h.eLinePerTime--;else while(h.eLinePerTime<1)if(await d(10),h.exit)break}function u(){h.eLinePerTime=15+l,h.motion={up:1,down:1,throw:1},h.exit=!1}async function p(){}function g(e){return e<10&&(e="0"+e),e}function w(e){r.debugLogArray.push(g((new Date).getMinutes())+":"+g((new Date).getSeconds())+">"+e),r.debugLogArray.length>500&&r.debugLogArray.slice(50)}async function m(){console.log("--- breakpoint ---"),w("@Breakpoint"),"start"==r.pgStatus100ms.status&&r.pauseJS();while("pause"==r.pgStatus100ms.status)if(await d(10),"gameover"==r.game.config.blocklyControlName.scene&&(c=!1,h.exit=!0,window.messager.toClientMessage("player1",{who:"Server",cmd:"gameCRexit",value:!0,key:""})),h.exit)break}function b(e){switch(e.cmd){case"debugLog":w(e.value);break;default:return penguinAction(e.cmd)}}async function C(e){return new Promise((async t=>{switch(e.cmd){case"bRCheck":t(await k());break;case"breakpoint":t(await m());break;case"endOfWhilePauseCheck":t(await p());break;default:console.log("Error. non Support cmd:",e),t("Error!");break}}))}class y{constructor(){console.log("The Messager Manager"),this.state="init",this.message="",this.clientOBJ={},this.serverCallback=null,this.serverCallbackAsync=null}setServerCallback(e){this.serverCallback=e}setServerCallbackAsync(e){this.serverCallbackAsync=e}async toServerMessageAsync(e){return new Promise((async t=>{null!=this.serverCallbackAsync?t(await this.serverCallbackAsync(e)):t("error!")}))}toServerMessage(e){return null!=this.serverCallback?this.serverCallback(e):"error!"}toClientAllMessage(e){for(let t in window.messager.clientOBJ)window.messager.clientOBJ[t].toClientMessage(e)}toClientMessage(e,t){void 0!=window.messager.clientOBJ[e]&&window.messager.clientOBJ[e].toClientMessage(t)}}window.messager=new y,window.messager.setServerCallback(b),window.messager.setServerCallbackAsync(C);const v=(0,s.Q_)("blocklyData",{state:()=>({hasJSWindow:!1,hasBPackWindow:!1,hasDebugWindow:!1,hasUserWindow:!1,zIndex:{JS:2,backpack:2,debug:2},mainWorkspaceID:null,myBackpackOBJ:null,isBlocklyInit:!1,blocklyFlyout:{drag:1,move:1},jsWindowCode:"",runJSCode:"",prepareUpdateBlocks:!0,debugLogArray:[],backpack_newXML_temp:"",backpack_newXML_name:"",backpack_newXML_hotkey:"",backpack_newXML_describe:"",backpack_isSearchEnable:!0,backpack_dialogbkAddNew:!1,backpackWindow:{}}),getters:{},actions:{zIndexWindowTop(e){this.zIndex.JS=this.zIndex.JS>2?this.zIndex.JS-1:2,this.zIndex.backpack=this.zIndex.backpack>2?this.zIndex.backpack-1:2,this.zIndex.debug=this.zIndex.debug>2?this.zIndex.debug-1:2,this.zIndex[e]=10},getMainWorkspace(){return n().Workspace.getById(this.mainWorkspaceID)},exitJSCode(){h.exit||(c=!1,h.exit=!0,window.messager.toClientMessage("player1",{who:"Server",cmd:"gameCRexit",value:!0,key:""}))},gameCRReflash(){c&&(h.exit||(h.eLinePerTime=15+l,h.motion={up:1,down:1,throw:1},h.exit=!1))},dialogAddNewIntoBackPack(){this.backpackDataOBJ.user.blocks.push({name:this.backpack_newXML_name,displayIndexByCount:1,describe:this.backpack_newXML_describe,hotkeys:[this.backpack_newXML_hotkey],xml:this.backpack_newXML_temp,style:"background-color: lightblue;"}),this.backpack_dialogbkAddNew=!1,this.backpack_isSearchEnable=!0},gameNameInit(){if(!this.isBlocklyInit){r=this,this.isBlocklyInit=!0;let e=setInterval((()=>{let t=this.getMainWorkspace();if(console.log("-workspace ID:",t.id),void 0!=t){clearInterval(e);const o={allowEmptyBackpackOpen:!0};this.myBackpackOBJ=new i.jw(t,o),this.myBackpackOBJ.init(),t.clearUndo(),this.getMainWorkspace().addChangeListener(this.blockChangeEvent),this.getMainWorkspace().addChangeListener(n().Events.disableOrphans)}}),300)}},blockChangeEvent(e){if(console.log("this.blockChangeEvent---\x3e",e.workspaceId,e.type),"toolbox_item_select"==e.type)this.getMainWorkspace().toolbox_.flyout_.autoClose=!1;else if("create"==e.type)this.getMainWorkspace().toolbox_.flyout_.autoClose=!1,this.blocklyFlyout={drag:2,move:1};else if("drag"==e.type)switch(this.blocklyFlyout.drag){case 2:this.blocklyFlyout.drag=1;break;case 1:this.blocklyFlyout.drag=0;break;case 0:this.blocklyFlyout.drag=-1,this.getMainWorkspace().toolbox_.flyout_.autoClose=!0,this.getMainWorkspace().toolbox_.clearSelection(),this.getMainWorkspace().recordDragTargets();break;default:break}else if("viewport_change"==e.type||"click"==e.type)this.getMainWorkspace().toolbox_.flyout_.autoClose=!0,this.getMainWorkspace().toolbox_.clearSelection(),this.getMainWorkspace().recordDragTargets();else if("backpack_change"==e.type){let e=this.myBackpackOBJ.getContents();""!=e&&(this.myBackpackOBJ.empty(),console.log("--backpack_change contents->",e[0]),this.backpack_newXML_temp="<xml>"+e[0]+"</xml>",this.backpack_isSearchEnable=!1,this.backpack_dialogbkAddNew=!0)}else if(("move"==e.type||"change"==e.type)&&"move"==e.type)switch(this.blocklyFlyout.move){case 1:this.blocklyFlyout.move=0;break;case 0:this.blocklyFlyout.move=-1,this.getMainWorkspace().toolbox_.flyout_.autoClose=!0,this.getMainWorkspace().toolbox_.clearSelection(),this.getMainWorkspace().recordDragTargets();break;default:break}if(r.prepareUpdateBlocks){r.prepareUpdateBlocks=!1;let e=r.rootJSCodeFN(!1);e!=r.runJSCode?(console.log("500ms, due tonewJSCode != vueThis.runJSCode.."),this.exitJSCode(),setTimeout((()=>{u(),r.runJSCode=e,r.prepareUpdateBlocks=!0,c=!0,r.doFunction(e)}),500)):r.prepareUpdateBlocks=!0}},doFunction(e){let t='\n        (async () => {\n          console.log("Blockly JS start");\n          let who = "player1";\n          let doDebug = true;\n          function debugLog(theLog) {\n            return window.messager.toServerMessage({\n              who: who,\n              cmd: "debugLog",\n              key: "",\n              value: theLog,\n            });\n          }\n          async function sleep(ms) {\n            return new Promise((resolve) =>\n              setTimeout(() => {\n                resolve();\n              }, ms)\n            );\n          }\n          let gameCR={\n            exit:false\n          };\n          function toClientMessage(theMSG) {\n            //console.log(who + ":Client Received MSG:", theMSG);\n            switch (theMSG.cmd) {\n              case "gameCRexit":\n                gameCR.exit = theMSG.value;\n                break;\n\n              default:\n                //console.log(who + ":unknow cmd:", theMSG);\n                break;\n            }\n          }\n          window.messager.clientOBJ[who] = {\n            toClientMessage: toClientMessage,\n          };\n          //   console.log("receive MSG:", theMSG);\n          //   await window.messager.serverCallback();\n          //   console.log("end call of Server from Client");\n          // });\n\n          async function bRCheck() {\n            return await window.messager.toServerMessageAsync({\n              who: who,\n              cmd: "bRCheck",\n              key: "",\n            });\n          }\n          async function breakpoint() {\n            return await window.messager.toServerMessageAsync({\n              who: who,\n              cmd: "breakpoint",\n              key: "",\n            });\n          }\n          //in case user put new blockly into start, do them unitl while end only.\n          async function endOfWhilePauseCheck() {\n            return await window.messager.toServerMessageAsync({\n              who: who,\n              cmd: "endOfWhilePauseCheck",\n              key: "",\n            });\n          }\n\n          function penguinAction(theMotion) {\n            return window.messager.toServerMessage({\n              who: who,\n              cmd: theMotion,\n              key: "",\n            });\n          }\n          function aTrackSnowmenFn(trackID) {\n            return window.messager.toServerMessage({\n              who: who,\n              cmd: "theTrackID" + trackID,\n              key: "",\n            });\n          }\n          '+e+"userFunction();\n          })();\n        ",o=new Function(t);o()},find_rootBlock(e){for(var t,o=this.getMainWorkspace().getTopBlocks(!1),s=0;t=o[s];s++)if(t.type==e)return t;return null},rootJSCodeFN(e){let t="if ((--window.LoopTrap) < 0) gameCR.exit=2;\n";window.LoopTrap=1e3,n().JavaScript.INFINITE_LOOP_TRAP=t;var o=n().JavaScript.workspaceToCode(this.getMainWorkspace());e&&console.log("--- workspaceToCode ---\x3e",o);var s="";if("var "==o.slice(0,4)){let e=o.indexOf(";");e>-1&&(s=o.slice(0,e+1)+s)}e&&console.log("--- workspaceToCode var ---\x3e",s),e&&console.log("--- wsCode var ---\x3e",o);let a="",i="",r="",c=o.split("function "),h=[];n().JavaScript.init(this.getMainWorkspace());for(let n=c.length-1;n>0;n--){let t=c[n].split("(")[0],o=c[n].split("\n\n")[0];if("mathRandomInt"!=t){let s=o.split("return ");if(s.length>1)if(2==s.length){let e=s[1].replace(";",");");o=s[0]+"resolve("+e}else console.log("--- has issue to check return of FN");s=o.split("{");let n="";if(s.length>1){n="\nasync function "+s[0]+"{ return new Promise(async function (resolve, reject) {"+s[1],e&&console.log("--- tempIndex ---",s);let t=2;for(;t<s.length;)n=n+"{"+s[t],t++;for(s=n.split("}"),n=s[0],t=1;t<s.length-1;t++)n=n+"}"+s[t];i=i+n.split("window.alert").join("console.log")+"resolve();});}\n",n=n.split(";\n").join(";\nawait bRCheck();\n"),n=n.split("window.alert").join("if(doDebug) debugLog"),n=n.split("}").join("await bRCheck();\nif(gameCR.exit){break;}\n}"),a=a+n+"resolve();});}\n"}h.push(t)}else r=r+"\n function "+o+"\n"}e&&console.log("--- async Function ---",a),e&&console.log("--- Default Function ---",r),n().JavaScript.init(this.getMainWorkspace());var d=this.find_rootBlock("player_start"),k=n().JavaScript.blockToCode(d);return e&&console.log("--- rootBlock ---\x3e",k),this.jsWindowCode="{\n"+s+"\n"+i+"\n"+a+"\nfunction startFn(){"+k.split("window.alert").join("console.log")+"}\n}",this.jsWindowCode=this.jsWindowCode.split("if ((--window.LoopTrap) < 0) gameCR.exit=2;").join(""),k=k.split(";\n").join(";\nawait bRCheck();\n"),k=k.split("window.alert").join("if(doDebug) debugLog"),k=k.split("}").join("await bRCheck();\nif(gameCR.exit){break;}\n}"),e&&console.log("--- rootBlock after ---\x3e",k),k="{\n"+s+"\n"+r+"\n"+a+"\nthis.userFunction=async()=>{while(!gameCR.exit){try{"+k,k+="}catch(e){console.log('Catch Err:',e);debugLog(e);gameCR.exit=3;}await bRCheck();await endOfWhilePauseCheck();window.LoopTrap =1000;}console.log('---Exit---',gameCR.exit)}\n}",l=k.split("--window.LoopTrap").length-1,e&&console.log("--- loopTrapAddBack ---\x3e",l),h.forEach((e=>{k=k.split(e+"();").join("await "+e+"();").split(e+"());").join("await "+e+"());")})),e&&console.log("--- modify rootJSCode ---",k),k}}})},36449:(e,t,o)=>{o.d(t,{y:()=>a});o(69665);var s=o(3746);const a=(0,s.Q_)("chatData",{state:()=>({chatRoomObj:[],chatDatabyID:{},data:null,chatToID:null,chatLogPreview:null,previewJavascript:"",chatType:{input:1,javascript:2,markdown:3,current:1,autoSelected:!0},chatKeep:{input:"",javascript:"",markdown:""}}),getters:{},actions:{socketChatTextAdd(e,t){console.log("socketChatTextAdd:",e,t),void 0!=this.chatDatabyID[e]?this.chatDatabyID[e].push(t):console.error("socketChatTextAdd Error, Why without init",e,t)},socketChatTextIn(e){console.log("socketChatTextIn:",e),void 0==e.groupChatID?(void 0==this.chatDatabyID[e.from]&&(this.chatDatabyID[e.from]=[]),this.chatDatabyID[e.from].push(e)):console.log("Group Chat socketChatTextIn:",e)},newChatTextFromWKR(e){console.log("newChatTextFromWKR:",e)},setchatToID(e){this.chatToID=e},addchatRoomObj(e){this.chatRoomObj=e,e.forEach((e=>{this.chatDatabyID[e._id]=["First Message!"]}))}}})},62130:(e,t,o)=>{o.d(t,{v:()=>i});o(69665);var s=o(30242),a=o(19302),n=o(3746);const i=(0,n.Q_)("userStores",{state:()=>({$q:(0,a.Z)(),isLogin:!1,counter:0,userOrGroupByID:{},data:null,socket:null,saFrientGroupID:[],jaAskForJoinContact:[],jaWaitForAcceptContact:[],hideContactList:[]}),getters:{doubleCount:e=>2*e.counter},actions:{logout(){this.isLogin=!1,this.counter=0,this.userOrGroupByID={},this.data=null,this.socket=null,this.saFrientGroupID=[],this.jaAskForJoinContact=[],this.jaWaitForAcceptContact=[],this.hideContactList=[]},setSocket(e){this.socket=e},socketEmiteventData(e,t){null!=this.socket&&this.socket.emit(e,t)},addContactUserOrGroup(e){void 0==this.userOrGroupByID[e._id]&&(this.userOrGroupByID[e._id]={_id:e._id,sNameChange:void 0!=e.sRemoteNameChange?e.sRemoteNameChange:void 0!=e.sRemoteNickName?e.sRemoteNickName:e.sRemoteName,dataInfo:e}),this.saFrientGroupID.push(e._id)},addUser(e){void 0==this.userOrGroupByID[e._id]&&(this.userOrGroupByID[e._id]={_id:e._id,name:e.name,currentInfo:e.currentInfo,avatar:e.avatar,email:e.email,phone:e.phone,website:e.website,address:e.address,groupID:e.groupID,socketIDList:[]}),this.userOrGroupByID[e._id].socketIDList.push(e.socketID)},removeUser(e){if(console.log("working on remove ",this.userOrGroupByID[e._id].socketIDList),console.log("working on remove ",this.userOrGroupByID[e._id].socketIDList.length),void 0!=this.userOrGroupByID[e._id])if(1==this.userOrGroupByID[e._id].socketIDList.length)delete this.userOrGroupByID[e._id];else{console.log("--- not support yet , should add");let t=this.userOrGroupByID[e._id].socketIDList;for(let o=t.length-1;o>-1;o--)if(t[o]==e.socketID){t.splice(o,1);break}}},socketUserIn(e){switch(e.cmd){case"waitForAccept":delete e.cmd,e.sLocalUserID=this.data._id,e.sLocalUserIDRemote=e.sLocalUserID+"^"+e.sRemoteUserID,console.log("waitForAccept:",e);const t=this.jaWaitForAcceptContact.findIndex((t=>t.sRemoteUserID==e.sRemoteUserID));this.$q.notify({type:"positive",position:"bottom-left",color:"teal",message:e.sRemoteContactID+" is asking for joining",icon:"tag_faces"}),-1==t?this.jaWaitForAcceptContact.push(e):(this.jaWaitForAcceptContact[t]=e,console.log("Already in waitForAccept list"));break;case"acceptUser":delete e.cmd;const o=this.jaAskForJoinContact.findIndex((t=>t.sRemoteUserID==e.sRemoteUserID));let a=this.jaAskForJoinContact[o];a.nRemoteState=e.nRemoteState,a.sRemoteName=e.sRemoteName,a.sRemoteNickName=e.sRemoteNickName,a.sRemoteUserID=e.sRemoteUserID,a.nLocalState=s.B3.ok,this.addContactUserOrGroup(this.jaAskForJoinContact[o]),this.jaAskForJoinContact.splice(o,1);break;case constchatContact.askForJoin:break;default:console.log("Unknow CMD - User Pinia- SocketData:",e)}}}})},68513:(e,t,o)=>{o.d(t,{d:()=>i});o(40702),o(84641),o(83269);var s=o(3746),a=o(36449),n=o(62130);const i=(0,s.Q_)("webWorkerStore",{state:()=>({hChatTextWorker:null,hUserWorker:null,chatPinia:(0,a.y)(),userPinia:(0,n.v)()}),getters:{},actions:{init(){this.initChatTextWorker()},initChatTextWorker(){let e=this;null==this.hChatTextWorker&&(this.hChatTextWorker=new Worker(new URL(o.p+o.u(531),o.b)),this.hChatTextWorker.onmessage=t=>{let o=t.data;switch(o.cmd){case"sourceChatOut":e.userPinia.socketEmiteventData("sourceChat",o.data);break;case"sourceChatIn":e.chatPinia.socketChatTextIn(o.data);break}}),null==this.hUserWorker&&(this.hUserWorker=new Worker(new URL(o.p+o.u(377),o.b)),this.hUserWorker.onmessage=t=>{let o=t.data;switch(o.cmd){case"sourceUserOut":console.log("Send sourceUser:",o.data);break;case"sourceUserIn":console.log("Receive sourceUser:",o.data),e.userPinia.socketUserIn(o.data);break}})},sourceChatToWorkerAndSend(e,t){this.hChatTextWorker.postMessage({cmd:e+"Out",data:t})},sourceChatToWorkerAndReceive(e,t){this.hChatTextWorker.postMessage({cmd:e+"In",data:t})},sourceUserToWorkerAndReceive(e,t){this.hUserWorker.postMessage({cmd:e+"In",data:t})}}})},30242:(e,t,o)=>{o.d(t,{B3:()=>a,n0:()=>s});const s={ok:0,askForJoin:1,waitForAccept:2,rejectHide:3,connected:5},a={ok:0,noReqSessionUser:1,joinUser:{noContactID:1,notOpenToJoin:2,chatContactError:3,userError:5}}}}]);