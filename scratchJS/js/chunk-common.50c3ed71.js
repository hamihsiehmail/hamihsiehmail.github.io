"use strict";(globalThis["webpackChunkcircleworld"]=globalThis["webpackChunkcircleworld"]||[]).push([[64],{11445:(e,t,a)=>{a.d(t,{o:()=>s});var o=a(3746);const s=(0,o.Q_)("asPostmanData",{state:()=>({thisOBJ:{}}),getters:{},actions:{addThis(e){this.thisOBJ[e.$options.name]={theThis:e}},removeThis(e){delete this.thisOBJ[e.$options.name]}}})},57400:(e,t,a)=>{a.d(t,{B:()=>f});a(69665),a(18964);var o=a(3746),s=a(87790),n=a.n(s),i=a(36433),r=null;let c=!1,l=0,h={eLinePerTime:15+l,motion:{up:1,down:1,throw:1},exit:!1};async function k(e){return new Promise((t=>setTimeout(t,e)))}async function d(){if(h.eLinePerTime>0)h.eLinePerTime--;else while(h.eLinePerTime<1)if(await k(10),h.exit)break}function u(){h.eLinePerTime=15+l,h.motion={up:1,down:1,throw:1},h.exit=!1}async function p(){}function g(e){return e<10&&(e="0"+e),e}function m(e){r.debugLogArray.push(g((new Date).getMinutes())+":"+g((new Date).getSeconds())+">"+e),r.debugLogArray.length>500&&r.debugLogArray.slice(50)}async function w(){m("@Breakpoint"),"start"==r.pgStatus100ms.status&&r.pauseJS();while("pause"==r.pgStatus100ms.status)if(await k(10),"gameover"==r.game.config.blocklyControlName.scene&&(c=!1,h.exit=!0,window.messager.toClientMessage("player1",{who:"Server",cmd:"gameCRexit",value:!0,key:""})),h.exit)break}function b(e){switch(e.cmd){case"debugLog":m(e.value);break;default:return penguinAction(e.cmd)}}async function y(e){return new Promise((async t=>{switch(e.cmd){case"bRCheck":t(await d());break;case"breakpoint":t(await w());break;case"endOfWhilePauseCheck":t(await p());break;default:t("Error!");break}}))}class C{constructor(){this.state="init",this.message="",this.clientOBJ={},this.serverCallback=null,this.serverCallbackAsync=null}setServerCallback(e){this.serverCallback=e}setServerCallbackAsync(e){this.serverCallbackAsync=e}async toServerMessageAsync(e){return new Promise((async t=>{null!=this.serverCallbackAsync?t(await this.serverCallbackAsync(e)):t("error!")}))}toServerMessage(e){return null!=this.serverCallback?this.serverCallback(e):"error!"}toClientAllMessage(e){for(let t in window.messager.clientOBJ)window.messager.clientOBJ[t].toClientMessage(e)}toClientMessage(e,t){void 0!=window.messager.clientOBJ[e]&&window.messager.clientOBJ[e].toClientMessage(t)}}window.messager=new C,window.messager.setServerCallback(b),window.messager.setServerCallbackAsync(y);const f=(0,o.Q_)("blocklyData",{state:()=>({hasJSWindow:!1,hasBPackWindow:!1,hasDebugWindow:!1,hasUserWindow:!1,hasBlockly:!0,zIndex:{JS:2,backpack:2,debug:2},mainWorkspaceID:null,myBackpackOBJ:null,isBlocklyInit:!1,blocklyFlyout:{drag:1,move:1},jsWindowCode:"",runJSCode:"",prepareUpdateBlocks:!0,debugLogArray:[],backpack_newXML_temp:"",backpack_newXML_name:"",backpack_newXML_hotkey:"",backpack_newXML_describe:"",backpack_isSearchEnable:!0,backpack_dialogbkAddNew:!1,backpackWindow:{}}),getters:{},actions:{zIndexWindowTop(e){this.zIndex.JS=this.zIndex.JS>2?this.zIndex.JS-1:2,this.zIndex.backpack=this.zIndex.backpack>2?this.zIndex.backpack-1:2,this.zIndex.debug=this.zIndex.debug>2?this.zIndex.debug-1:2,this.zIndex[e]=10},getMainWorkspace(){return n().Workspace.getById(this.mainWorkspaceID)},exitJSCode(){h.exit||(c=!1,h.exit=!0,window.messager.toClientMessage("player1",{who:"Server",cmd:"gameCRexit",value:!0,key:""}))},gameCRReflash(){c&&(h.exit||(h.eLinePerTime=15+l,h.motion={up:1,down:1,throw:1},h.exit=!1))},dialogAddNewIntoBackPack(){this.backpackDataOBJ.user.blocks.push({name:this.backpack_newXML_name,displayIndexByCount:1,describe:this.backpack_newXML_describe,hotkeys:[this.backpack_newXML_hotkey],xml:this.backpack_newXML_temp,style:"background-color: lightblue;"}),this.backpack_dialogbkAddNew=!1,this.backpack_isSearchEnable=!0},gameNameInit(){if(!this.isBlocklyInit){r=this,this.isBlocklyInit=!0;let e=setInterval((()=>{let t=this.getMainWorkspace();if(void 0!=t){clearInterval(e);const a={allowEmptyBackpackOpen:!0};this.myBackpackOBJ=new i.jw(t,a),this.myBackpackOBJ.init(),t.clearUndo(),this.getMainWorkspace().addChangeListener(this.blockChangeEvent),this.getMainWorkspace().addChangeListener(n().Events.disableOrphans)}}),300)}},blockChangeEvent(e){if("toolbox_item_select"==e.type)this.getMainWorkspace().toolbox_.flyout_.autoClose=!1;else if("create"==e.type)this.getMainWorkspace().toolbox_.flyout_.autoClose=!1,this.blocklyFlyout={drag:2,move:1};else if("drag"==e.type)switch(this.blocklyFlyout.drag){case 2:this.blocklyFlyout.drag=1;break;case 1:this.blocklyFlyout.drag=0;break;case 0:this.blocklyFlyout.drag=-1,this.getMainWorkspace().toolbox_.flyout_.autoClose=!0,this.getMainWorkspace().toolbox_.clearSelection(),this.getMainWorkspace().recordDragTargets();break;default:break}else if("viewport_change"==e.type||"click"==e.type)this.getMainWorkspace().toolbox_.flyout_.autoClose=!0,this.getMainWorkspace().toolbox_.clearSelection(),this.getMainWorkspace().recordDragTargets();else if("backpack_change"==e.type){let e=this.myBackpackOBJ.getContents();""!=e&&(this.myBackpackOBJ.empty(),this.backpack_newXML_temp="<xml>"+e[0]+"</xml>",this.backpack_isSearchEnable=!1,this.backpack_dialogbkAddNew=!0)}else if(("move"==e.type||"change"==e.type)&&"move"==e.type)switch(this.blocklyFlyout.move){case 1:this.blocklyFlyout.move=0;break;case 0:this.blocklyFlyout.move=-1,this.getMainWorkspace().toolbox_.flyout_.autoClose=!0,this.getMainWorkspace().toolbox_.clearSelection(),this.getMainWorkspace().recordDragTargets();break;default:break}if(r.prepareUpdateBlocks){r.prepareUpdateBlocks=!1;let e=r.rootJSCodeFN(!1);e!=r.runJSCode?(this.exitJSCode(),setTimeout((()=>{u(),r.runJSCode=e,r.prepareUpdateBlocks=!0,c=!0,r.doFunction(e)}),500)):r.prepareUpdateBlocks=!0}},doFunction(e){let t='\n        (async () => {\n          console.log("Blockly JS start");\n          let who = "player1";\n          let doDebug = true;\n          function debugLog(theLog) {\n            return window.messager.toServerMessage({\n              who: who,\n              cmd: "debugLog",\n              key: "",\n              value: theLog,\n            });\n          }\n          async function sleep(ms) {\n            return new Promise((resolve) =>\n              setTimeout(() => {\n                resolve();\n              }, ms)\n            );\n          }\n          let gameCR={\n            exit:false\n          };\n          function toClientMessage(theMSG) {\n            //console.log(who + ":Client Received MSG:", theMSG);\n            switch (theMSG.cmd) {\n              case "gameCRexit":\n                gameCR.exit = theMSG.value;\n                break;\n\n              default:\n                //console.log(who + ":unknow cmd:", theMSG);\n                break;\n            }\n          }\n          window.messager.clientOBJ[who] = {\n            toClientMessage: toClientMessage,\n          };\n          //   console.log("receive MSG:", theMSG);\n          //   await window.messager.serverCallback();\n          //   console.log("end call of Server from Client");\n          // });\n\n          async function bRCheck() {\n            return await window.messager.toServerMessageAsync({\n              who: who,\n              cmd: "bRCheck",\n              key: "",\n            });\n          }\n          async function breakpoint() {\n            return await window.messager.toServerMessageAsync({\n              who: who,\n              cmd: "breakpoint",\n              key: "",\n            });\n          }\n          //in case user put new blockly into start, do them unitl while end only.\n          async function endOfWhilePauseCheck() {\n            return await window.messager.toServerMessageAsync({\n              who: who,\n              cmd: "endOfWhilePauseCheck",\n              key: "",\n            });\n          }\n\n          function penguinAction(theMotion) {\n            return window.messager.toServerMessage({\n              who: who,\n              cmd: theMotion,\n              key: "",\n            });\n          }\n          function aTrackSnowmenFn(trackID) {\n            return window.messager.toServerMessage({\n              who: who,\n              cmd: "theTrackID" + trackID,\n              key: "",\n            });\n          }\n          '+e+"userFunction();\n          })();\n        ",a=new Function(t);a()},find_rootBlock(e){for(var t,a=this.getMainWorkspace().getTopBlocks(!1),o=0;t=a[o];o++)if(t.type==e)return t;return null},rootJSCodeFN(e){let t="if ((--window.LoopTrap) < 0) gameCR.exit=2;\n";window.LoopTrap=1e3,n().JavaScript.INFINITE_LOOP_TRAP=t;var a=n().JavaScript.workspaceToCode(this.getMainWorkspace()),o="";if("var "==a.slice(0,4)){let e=a.indexOf(";");e>-1&&(o=a.slice(0,e+1)+o)}let s="",i="",r="",c=a.split("function "),h=[];n().JavaScript.init(this.getMainWorkspace());for(let n=c.length-1;n>0;n--){let e=c[n].split("(")[0],t=c[n].split("\n\n")[0];if("mathRandomInt"!=e){let a=t.split("return ");if(a.length>1&&2==a.length){let e=a[1].replace(";",");");t=a[0]+"resolve("+e}a=t.split("{");let o="";if(a.length>1){o="\nasync function "+a[0]+"{ return new Promise(async function (resolve, reject) {"+a[1];let e=2;for(;e<a.length;)o=o+"{"+a[e],e++;for(a=o.split("}"),o=a[0],e=1;e<a.length-1;e++)o=o+"}"+a[e];i=i+o.split("window.alert").join("console.log")+"resolve();});}\n",o=o.split(";\n").join(";\nawait bRCheck();\n"),o=o.split("window.alert").join("if(doDebug) debugLog"),o=o.split("}").join("await bRCheck();\nif(gameCR.exit){break;}\n}"),s=s+o+"resolve();});}\n"}h.push(e)}else r=r+"\n function "+t+"\n"}n().JavaScript.init(this.getMainWorkspace());var k=this.find_rootBlock("player_start"),d=n().JavaScript.blockToCode(k);return this.jsWindowCode="{\n"+o+"\n"+i+"\n"+s+"\nfunction startFn(){"+d.split("window.alert").join("console.log")+"}\n}",this.jsWindowCode=this.jsWindowCode.split("if ((--window.LoopTrap) < 0) gameCR.exit=2;").join(""),d=d.split(";\n").join(";\nawait bRCheck();\n"),d=d.split("window.alert").join("if(doDebug) debugLog"),d=d.split("}").join("await bRCheck();\nif(gameCR.exit){break;}\n}"),d="{\n"+o+"\n"+r+"\n"+s+"\nthis.userFunction=async()=>{while(!gameCR.exit){try{"+d,d+="}catch(e){console.log('Catch Err:',e);debugLog(e);gameCR.exit=3;}await bRCheck();await endOfWhilePauseCheck();window.LoopTrap =1000;}console.log('---Exit---',gameCR.exit)}\n}",l=d.split("--window.LoopTrap").length-1,h.forEach((e=>{d=d.split(e+"();").join("await "+e+"();").split(e+"());").join("await "+e+"());")})),d}}})},36449:(e,t,a)=>{a.d(t,{y:()=>s});a(69665);var o=a(3746);const s=(0,o.Q_)("chatData",{state:()=>({chatRoomObj:[],chatDatabyID:{},data:null,chatToID:null,chatLogPreview:null,previewJavascript:"",chatType:{input:1,javascript:2,markdown:3,current:1,autoSelected:!0},chatKeep:{input:"",javascript:"",markdown:""}}),getters:{},actions:{socketChatTextAdd(e,t){void 0!=this.chatDatabyID[e]&&this.chatDatabyID[e].push(t)},socketChatTextIn(e){void 0==e.groupChatID&&(void 0==this.chatDatabyID[e.from]&&(this.chatDatabyID[e.from]=[]),this.chatDatabyID[e.from].push(e))},newChatTextFromWKR(e){},setchatToID(e){this.chatToID=e},addchatRoomObj(e){this.chatRoomObj=e,e.forEach((e=>{this.chatDatabyID[e._id]=["First Message!"]}))}}})},62130:(e,t,a)=>{a.d(t,{v:()=>i});a(69665);var o=a(30242),s=a(19302),n=a(3746);const i=(0,n.Q_)("userStores",{state:()=>({$q:(0,s.Z)(),isLogin:!1,localStorage:{localeUI:"en-US",localeBlockly:"en"},counter:0,userOrGroupByID:{},data:null,socket:null,saFrientGroupID:[],jaAskForJoinContact:[],jaWaitForAcceptContact:[],hideContactList:[]}),getters:{doubleCount:e=>2*e.counter},actions:{logout(){this.isLogin=!1,this.counter=0,this.userOrGroupByID={},this.data=null,this.socket=null,this.saFrientGroupID=[],this.jaAskForJoinContact=[],this.jaWaitForAcceptContact=[],this.hideContactList=[]},setSocket(e){this.socket=e},socketEmiteventData(e,t){null!=this.socket&&this.socket.emit(e,t)},addContactUserOrGroup(e){void 0==this.userOrGroupByID[e._id]&&(this.userOrGroupByID[e._id]={_id:e._id,sNameChange:void 0!=e.sRemoteNameChange?e.sRemoteNameChange:void 0!=e.sRemoteNickName?e.sRemoteNickName:e.sRemoteName,dataInfo:e}),this.saFrientGroupID.push(e._id)},addUser(e){void 0==this.userOrGroupByID[e._id]&&(this.userOrGroupByID[e._id]={_id:e._id,name:e.name,currentInfo:e.currentInfo,avatar:e.avatar,email:e.email,phone:e.phone,website:e.website,address:e.address,groupID:e.groupID,socketIDList:[]}),this.userOrGroupByID[e._id].socketIDList.push(e.socketID)},removeUser(e){if(void 0!=this.userOrGroupByID[e._id])if(1==this.userOrGroupByID[e._id].socketIDList.length)delete this.userOrGroupByID[e._id];else{let t=this.userOrGroupByID[e._id].socketIDList;for(let a=t.length-1;a>-1;a--)if(t[a]==e.socketID){t.splice(a,1);break}}},socketUserIn(e){switch(e.cmd){case"waitForAccept":delete e.cmd,e.sLocalUserID=this.data._id,e.sLocalUserIDRemote=e.sLocalUserID+"^"+e.sRemoteUserID;const t=this.jaWaitForAcceptContact.findIndex((t=>t.sRemoteUserID==e.sRemoteUserID));this.$q.notify({type:"positive",position:"bottom-left",color:"teal",message:e.sRemoteContactID+" is asking for joining",icon:"tag_faces"}),-1==t?this.jaWaitForAcceptContact.push(e):this.jaWaitForAcceptContact[t]=e;break;case"acceptUser":delete e.cmd;const a=this.jaAskForJoinContact.findIndex((t=>t.sRemoteUserID==e.sRemoteUserID));let s=this.jaAskForJoinContact[a];s.nRemoteState=e.nRemoteState,s.sRemoteName=e.sRemoteName,s.sRemoteNickName=e.sRemoteNickName,s.sRemoteUserID=e.sRemoteUserID,s.nLocalState=o.B3.ok,this.addContactUserOrGroup(this.jaAskForJoinContact[a]),this.jaAskForJoinContact.splice(a,1);break;case constchatContact.askForJoin:break;default:}}}})},68513:(e,t,a)=>{a.d(t,{d:()=>i});a(40702),a(84641),a(83269);var o=a(3746),s=a(36449),n=a(62130);const i=(0,o.Q_)("webWorkerStore",{state:()=>({hChatTextWorker:null,hUserWorker:null,chatPinia:(0,s.y)(),userPinia:(0,n.v)()}),getters:{},actions:{init(){this.initChatTextWorker()},initChatTextWorker(){let e=this;null==this.hChatTextWorker&&(this.hChatTextWorker=new Worker(new URL(a.p+a.u(531),a.b)),this.hChatTextWorker.onmessage=t=>{let a=t.data;switch(a.cmd){case"sourceChatOut":e.userPinia.socketEmiteventData("sourceChat",a.data);break;case"sourceChatIn":e.chatPinia.socketChatTextIn(a.data);break}}),null==this.hUserWorker&&(this.hUserWorker=new Worker(new URL(a.p+a.u(377),a.b)),this.hUserWorker.onmessage=t=>{let a=t.data;switch(a.cmd){case"sourceUserOut":break;case"sourceUserIn":e.userPinia.socketUserIn(a.data);break}})},sourceChatToWorkerAndSend(e,t){this.hChatTextWorker.postMessage({cmd:e+"Out",data:t})},sourceChatToWorkerAndReceive(e,t){this.hChatTextWorker.postMessage({cmd:e+"In",data:t})},sourceUserToWorkerAndReceive(e,t){this.hUserWorker.postMessage({cmd:e+"In",data:t})}}})},30242:(e,t,a)=>{a.d(t,{B3:()=>s,n0:()=>o});const o={ok:0,askForJoin:1,waitForAccept:2,rejectHide:3,connected:5},s={ok:0,noReqSessionUser:1,joinUser:{noContactID:1,notOpenToJoin:2,chatContactError:3,userError:5}}}}]);